<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slide Preview</title>

  <!-- reveal.js CSS -->
  <link rel="stylesheet" href="/reveal.js/dist/reveal.css">
  <!-- ê¸°ë³¸ í…Œë§ˆ (ë™ì ìœ¼ë¡œ êµì²´) -->
  <link id="reveal-theme" rel="stylesheet" href="/reveal.js/dist/theme/black.css">
  <!-- í”ŒëŸ¬ê·¸ì¸ CSS -->
  <link rel="stylesheet" href="/reveal.js/plugin/highlight/monokai.css">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    body.ready {
      opacity: 1;
    }
    .reveal {
      width: 100% !important;
      height: 100% !important;
      position: relative !important;
    }
    /* reveal.js ë ˆì´ì•„ì›ƒ ì™„ì „ ë¬´ì‹œ - ë‹¨ìˆœí•˜ê²Œ */
    .reveal .slides {
      position: relative !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      height: 100% !important;
      transform: none !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    .reveal .slides > section {
      width: 90% !important;
      height: 90% !important;
      max-width: 960px !important;
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      justify-content: center !important;
    }
  </style>
</head>
<body>
  <div class="reveal">
    <div class="slides">
      <!-- ì´ˆê¸° ê¸°ë³¸ ìŠ¬ë¼ì´ë“œ (reveal.js ì´ˆê¸°í™”ë¥¼ ìœ„í•´ í•„ìš”) -->
      <section>
        <h1>Loading...</h1>
        <p>Waiting for slides...</p>
      </section>
    </div>
  </div>

  <!-- reveal.js ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="/reveal.js/dist/reveal.js"></script>
  <script src="/reveal.js/plugin/markdown/markdown.js"></script>
  <script src="/reveal.js/plugin/highlight/highlight.js"></script>
  <script src="/reveal.js/plugin/notes/notes.js"></script>

  <script>
    let revealInitialized = false;
    let pendingUpdate = null;

    // reveal.js ì´ˆê¸°í™”
    async function initReveal() {
      if (revealInitialized) return;

      try {
        await Reveal.initialize({
          hash: true,
          controls: true,
          progress: true,
          center: true,
          transition: 'slide',
          slideNumber: true,
          width: 960,
          height: 700,
        });
        revealInitialized = true;
        console.log('âœ… reveal.js initialized in iframe');

        // ì´ˆê¸°í™” ì™„ë£Œ í›„ ë°”ë¡œ í‘œì‹œ
        setTimeout(() => {
          document.body.classList.add('ready');
          console.log('Body ready class added (after init)');
        }, 100);

        // CSS ë¡œë“œ ìƒíƒœ ë””ë²„ê¹…
        console.log('ğŸ” CSS Debug:');
        console.log('- reveal.css loaded:', !!document.querySelector('link[href*="reveal.css"]'));
        console.log('- theme CSS loaded:', !!document.querySelector('#reveal-theme'));
        console.log('- theme href:', document.querySelector('#reveal-theme')?.href);
        console.log('- body bg:', window.getComputedStyle(document.body).backgroundColor);
        console.log('- reveal bg:', window.getComputedStyle(document.querySelector('.reveal')).backgroundColor);

        // ëŒ€ê¸° ì¤‘ì¸ ì—…ë°ì´íŠ¸ê°€ ìˆìœ¼ë©´ ì‹¤í–‰
        if (pendingUpdate) {
          console.log('Processing pending update');
          updateSlides(pendingUpdate.slides, pendingUpdate.theme);
          pendingUpdate = null;
        }
      } catch (error) {
        console.error('âŒ Failed to initialize reveal.js:', error);
      }
    }

    // ìŠ¬ë¼ì´ë“œ HTML ìƒì„±
    function slidesToHTML(slides) {
      if (!slides || slides.length === 0) {
        return '<section><h1>No slides yet</h1><p>Start typing in the editor!</p></section>';
      }

      const sections = {};

      slides.forEach(slide => {
        const sectionId = slide.sectionId || 'default';
        if (!sections[sectionId]) {
          sections[sectionId] = [];
        }
        sections[sectionId].push(slide);
      });

      return Object.values(sections)
        .map(sectionSlides => {
          if (sectionSlides.length === 1) {
            return `<section>${sectionSlides[0].html}</section>`;
          } else {
            return `<section>\n${sectionSlides.map(s => `  <section>${s.html}</section>`).join('\n')}\n</section>`;
          }
        })
        .join('\n');
    }

    // í…Œë§ˆ ì ìš©
    function applyTheme(themeName) {
      const existingLink = document.getElementById('reveal-theme');
      if (existingLink) {
        existingLink.href = `/reveal.js/dist/theme/${themeName}.css`;
        console.log('Theme changed to:', themeName);
      }
    }

    // ìŠ¬ë¼ì´ë“œ ì—…ë°ì´íŠ¸
    function updateSlides(slides, theme) {
      const slidesContainer = document.querySelector('.reveal .slides');
      if (!slidesContainer) {
        console.error('Slides container not found');
        return;
      }

      // í˜„ì¬ ìœ„ì¹˜ ì €ì¥
      const state = revealInitialized ? Reveal.getState() : null;

      // HTML ìƒì„±
      const html = slidesToHTML(slides);
      console.log('Generated HTML length:', html.length);

      // HTML ì—…ë°ì´íŠ¸
      slidesContainer.innerHTML = html;
      console.log('Slides container updated');

      // í…Œë§ˆ ì ìš©
      if (theme) {
        applyTheme(theme);
      }

      // reveal.js ë™ê¸°í™”
      if (revealInitialized) {
        Reveal.sync();
        console.log('Reveal synced');

        // ìŠ¬ë¼ì´ë“œ ë ˆì´ì•„ì›ƒ ê°•ì œ ì—…ë°ì´íŠ¸
        Reveal.layout();
        console.log('Reveal layout updated');

        // ìœ„ì¹˜ ë³µì› (ì—ëŸ¬ ë°©ì§€)
        if (state && Reveal.slide) {
          setTimeout(() => {
            try {
              Reveal.slide(state.indexh, state.indexv || 0);
              console.log('Slide position restored:', state.indexh, state.indexv);
            } catch (e) {
              console.debug('Slide position restore skipped:', e.message);
            }
          }, 100);
        }
      }

      console.log('Slides updated:', slides.length);

      // ìŠ¬ë¼ì´ë“œ ì—…ë°ì´íŠ¸ í›„ ìƒ‰ìƒ ë° ìœ„ì¹˜ í™•ì¸
      setTimeout(() => {
        const presentSlide = document.querySelector('.reveal .slides section.present');
        const firstH1 = document.querySelector('.reveal .slides section.present h1');

        console.log('ğŸ” Slide Debug:');
        console.log('- Present slide exists:', !!presentSlide);
        console.log('- First h1 exists:', !!firstH1);

        if (firstH1) {
          const style = window.getComputedStyle(firstH1);
          console.log('- h1 color:', style.color);
          console.log('- h1 display:', style.display);
          console.log('- h1 visibility:', style.visibility);
          console.log('- h1 opacity:', style.opacity);
        }

        const revealEl = document.querySelector('.reveal');
        if (revealEl) {
          const revealStyle = window.getComputedStyle(revealEl);
          console.log('- reveal transform:', revealStyle.transform);
          console.log('- reveal position:', revealStyle.position);
          console.log('- reveal width:', revealEl.offsetWidth);
          console.log('- reveal height:', revealEl.offsetHeight);
          console.log('- reveal top:', revealEl.offsetTop);
          console.log('- reveal left:', revealEl.offsetLeft);
        }

        const slidesEl = document.querySelector('.reveal .slides');
        if (slidesEl) {
          const slidesStyle = window.getComputedStyle(slidesEl);
          console.log('- slides width:', slidesEl.offsetWidth);
          console.log('- slides height:', slidesEl.offsetHeight);
          console.log('- slides left:', slidesStyle.left);
          console.log('- slides top:', slidesStyle.top);
          console.log('- slides position:', slidesStyle.position);
          console.log('- slides style.transform:', slidesEl.style.transform);
          console.log('- slides computed transform:', slidesStyle.transform);
        }
      }, 200);
    }

    // postMessage ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('message', (event) => {
      if (event.data.type === 'UPDATE_SLIDES') {
        if (revealInitialized) {
          updateSlides(event.data.slides, event.data.theme);
        } else {
          console.log('Reveal not initialized yet, storing pending update');
          pendingUpdate = { slides: event.data.slides, theme: event.data.theme };
        }
      }
    });

    // ì´ˆê¸°í™”
    initReveal();
  </script>
</body>
</html>
